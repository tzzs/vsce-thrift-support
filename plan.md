# Thrift Language Support - 计划与进度

**当前版本**: 1.0.19

**最新状态**: ✅ `npm run test` 全量通过（219 passing）

本文档聚焦当前版本可执行的工作项与进度，按「概览 → 近期 → 中期 → 长期 → 已完成」结构组织。

---

## 0. 概览

- **主要目标**: 稳定增量格式化、持续提升测试与质量保障
- **当前重点**: 回归稳定、增量格式化边界正确性

### 0.1 当前风险评估

- [ ] 性能监控实例分裂：指标聚合口径不一致，导致性能报告偏差
- [ ] 缓存管理器与实际缓存分离：驱逐与命中统计断裂，内存评估失真
- [ ] 重复实现并存（缓存与增量模块）：行为差异扩大维护成本
- [ ] 优化模块未接线或未启用：代码体积上升但收益无法兑现
- [ ] AST 缓存注册重复触发：命中率被清空，触发意外全量解析
- [ ] 内存回收依赖 `global.gc`：默认运行环境无效，回收策略失灵
- [ ] 解析器大型文件热点路径：高峰期解析耗时抖动，编辑响应波动
- [ ] 增量解析受影响区域识别不准：重解析过大或漏算导致结果不一致
- [ ] 诊断调度产生重叠任务：分析队列堆积，UI 卡顿风险上升
- [ ] 变更合并与脏区计算不稳定：增量路径一致性与正确性下降
- [ ] 缓存过期与清理策略偏弱：大型工作区内存增长不可控
- [ ] AST 循环引用潜在保留：长会话下内存无法释放

---

## 1. 近期目标（P0 / 1-2 个月）

### 1.1 增量格式化稳定性

- [x] 修复范围格式化从 struct header 起始时的额外缩进问题
- [x] 添加回归测试（增量范围起点在 struct header）
- [x] 补充与 range formatting 相关的边界用例（空行开头、block comment 前置）

### 1.2 测试与验证

- [x] 全量测试通过（`npm run test`）
- [x] 覆盖率脚本稳定性修复（见 2.1）

### 1.3 缓存治理与一致性

- [ ] 统一 CacheManager 单一实现与注册入口
- [ ] include 类型缓存迁移到 LRU 策略并增加容量上限
- [ ] 缓存过期策略在大型工作区的主动清理与失效

---

## 2. 中期规划（P1 / 3-6 个月）

### 2.1 覆盖率脚本修复（✅ 已完成）

**状态**: `npm run coverage` 已改为 `nyc --reporter=text-summary mocha`，避免 Mocha 全局未注入问题。
- [x] 覆盖率脚本改为使用 Mocha
- [ ] CI 加入覆盖率任务，失败阻断合并

### 2.2 LSP 化与增量索引（规划中）

- [ ] 拆分 UI/语言服务层
- [ ] 诊断/符号/引用迁移到 LSP
- [ ] 索引缓存与 dirtyRange 更新策略

### 2.3 跨文件集成测试扩展

- [ ] include 链与循环依赖场景集成测试
- [ ] 引用/定义跨文件一致性与重命名回归用例
- [ ] 诊断与引用在增量/全量路径一致性验证

---

## 3. 长期方向（P2 / 6-12 个月）

- [ ] 高级编辑功能（Call Hierarchy/Type Hierarchy/Refactor）
- [ ] 语义诊断与 Quick Fix 扩展
- [ ] 性能基准与大型仓库压力测试
- [ ] 高级导航功能（查找所有引用/实现与调用层次结构）
- [ ] 代码补全模板与文档悬停增强
- [ ] 语义折叠与结构化导航增强
- [ ] 依赖注入容器与模块化架构改进
- [ ] 配置系统扩展与遥测/日志结构化

---

## 4. 已完成归档（近期）

- ✅ Mocha 测试框架迁移完成
- ✅ 测试用例全面修复与统一 mock 机制
- ✅ 增量格式化范围起点导致的额外缩进问题修复
- ✅ 增量格式化新增回归测试用例
- ✅ 覆盖率脚本改为 Mocha 运行
- ✅ 增量解析优化与区域缓存（OptimizedThriftParser/IncrementalParserManager）
- ✅ 增量变更跟踪优化（IncrementalTracker 合并与脏区计算）
- ✅ 高级 LRU 与内存感知缓存管理（Advanced/Optimized LRU、MemoryMonitor）
- ✅ 诊断节流与调度优化（debounce/throttle、调度队列）
- ✅ 引用 AST 缓存去重与 TTL 统一
- ✅ 类型安全强化与错误处理统一
- ✅ 代码重复治理（缓存键/过期/报告构建/错误包装）
- ✅ 性能监控优化与性能报告命令
- ✅ 扩展激活流程与性能组件集成
- ✅ 测试覆盖扩展与性能基准验证
- ✅ 内联帮助与配置说明完善

---

## 5. 成功指标

- 性能：1000 行文件格式化 <500ms，导航 <100ms，诊断全量分析 <200ms
- 可靠性：错误日志零崩溃，关键操作错误率 <1%
- 覆盖：测试覆盖率 >80%，重点路径有回归保护
- 可维护性：关键模块重复逻辑显著减少并持续收敛

---

## 6. 风险缓解

- 性能优化改动必须有回归测试覆盖
- 关键路径重构保持兼容与可回滚
- 复杂改动按功能标志分阶段落地

---

## 7. 版本与记录

| 版本   | 主要更新 |
|--------|----------|
| 1.0.19 | 增量格式化缩进修复与回归测试；覆盖率脚本修复；全量测试通过 |
| 1.0.13 | Mocha 测试迁移与 formatter/diagnostics 相关修复 |
| 1.0.12 | AST/Parser 重构，增量分析/格式化与性能优化 |

---

## 8. 贡献与验证要求

- 提交前运行 `npm run lint` 与 `npm run test`
- 遵循 Conventional Commits 规范
- 关键修复需包含最小回归测试
- 运行性能基准对比并记录关键指标
- 大型真实文件场景验证解析与诊断稳定性
