# 未来的优化与维护计划

本文档列出了在项目审查期间（2025年12月）发现的潜在改进和架构变更建议。这些项目目前不阻塞开发，但对于长期的可维护性和健壮性建议进行实施。

## 🚀 性能优化计划（2025年12月 - 高优先级）

**当前状态:** 用户反馈在编辑大文件时CPU占用很高，插件响应卡顿。
**问题分析:** 
- 诊断功能每次文档修改都立即触发完整分析
- AST解析没有缓存机制，重复解析相同内容
- 格式化时需要重新计算复杂上下文
- 包含文件分析存在重复文件系统操作

**性能瓶颈定位:**
1. `src/diagnostics.ts:847-853` - 诊断系统过度频繁触发
2. `src/ast/parser.ts` - AST解析器缺乏缓存
3. `src/formattingProvider.ts:100-150` - 格式化上下文计算复杂

**优化建议:**
- **诊断节流机制:** 添加300ms延迟，避免每次键盘输入都触发分析
- **AST缓存机制:** 缓存解析结果，避免重复解析相同内容
- **包含文件缓存:** 缓存已分析的包含文件类型信息
- **性能监控:** 添加慢操作检测和告警
- **增量分析:** 只分析变更部分，而非整个文档

**实施优先级:**
1. **立即实施**（高优先级）：诊断节流 + AST缓存
2. **中期改进**（中优先级）：增量格式化 + 并发控制
3. **长期优化**（低优先级）：Web Worker支持 + 智能增量分析

**预期效果:**
- CPU占用降低60-80%
- 大文件编辑响应时间从秒级降至毫秒级
- 内存使用优化，避免重复计算

## 1. 解析器健壮性 (`thriftParser.ts`)
**当前状态:** 严重依赖正则表达式来提取字段。
**问题:** 复杂的嵌套类型或边缘情况的语法（例如：泛型参数中的注释）可能会破坏正则匹配或产生错误结果。
**改进建议:**
- 从纯正则匹配过渡到基于状态的解析器或字符流解析器。
- 如果语法要求变得更复杂，实现一个合适的 Tokenizer/Lexer。
- **优先级:** 中（关注 bug 报告）。

## 2. 格式化器代码复杂性 (`thriftFormatter.ts`)
**当前状态:** `formatConstFields` 约有 200 行；`formatStructFields` 也相当复杂。
**问题:** 巨大的方法使得代码难以阅读、测试和维护。
**改进建议:**
- **重构 `formatConstFields`:** 将"内联集合展开"逻辑提取到单独的辅助类或方法中。
- **重构 `formatStructFields`:** 将对齐计算逻辑与实际的字符串重组分离开来。
- **优先级:** 低（下次修改这些方法时进行重构）。

## 3. 泛型类型解析 (`thriftFormatter.ts`)
**当前状态:** `normalizeGenericsInSignature` 使用计数器手动解析 `<` 和 `>` 的嵌套。
**问题:** 难以维护且容易出错。
**改进建议:**
- 对类型签名采用标准化的递归下降解析。
- 在 Parser 和 Formatter 之间复用此逻辑。
- **优先级:** 中。

## 4. AST 与类型安全
**当前状态:** 插件操作的是"行"和"正则匹配"，而不是真正的抽象语法树 (AST)。
**问题:** 如果没有真正的 AST，无法准确支持"查找引用"或"重命名符号"等高级功能。
**改进建议:**
- 引入轻量级的 AST 模型 (`ThriftDocument`, `ThriftNode`)。
- 在格式化之前将整个文档解析为这种树结构。
- **优先级:** 高（如果需要改进重命名/跳转定义等功能）。
- ✅ **已实现:** 已创建 AST 模型并应用于多个组件。

## 5. Provider 代码重构与逻辑统一
**当前状态:** `CompletionProvider`, `DocumentSymbolProvider`, 和 `ThriftParser` (用于格式化) 各自实现了独立的、基于正则的解析逻辑。
**问题:** 逻辑重复导致维护困难，修复一个 bug 可能需要在三个地方修改；且不一致的解析行为会导致不同功能表现不一致。
**改进建议:**
- 在实现 "4. AST 与类型安全" 后，重构所有 Provider 以依赖统一的 `ThriftDocument` / AST。
- 移除各 Provider 中临时的正则解析代码。
- **优先级:** 高（应与 AST 工作同步进行）。
- ✅ **已实现:** 已重构 Provider 使用统一的 AST 解析器。

## 6. LSP (Language Server Protocol) 迁移
**当前状态:** 所有功能均作为 VS Code 扩展直接实现 (`src/*.ts`)。
**问题:** 扩展主进程负载较重；逻辑无法复用到其他编辑器；难以实现增量编译和高效的跨文件索引。
**改进建议:**
- 将核心解析、诊断、格式化逻辑迁移到独立的 LSP Server。
- 客户端仅负责与 VS Code API 对接。
- **优先级:** 中/低（长期架构目标，见 `ToDo.md`）。