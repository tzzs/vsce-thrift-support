# Thrift Language Support - 计划与进度（重写版）

**当前版本**: 1.0.19  
**最新状态**: ✅ `npm run test` 全量通过（219 passing）

本文档用于统一当前阶段的目标、风险、里程碑与验收方式，便于在多次迭代中保持方向一致与可回溯。

---

## 0. 文档范围与原则

- **范围**: VS Code 扩展核心能力（格式化、诊断、导航、重构）及其性能与质量保障
- **原则**: 先稳定再演进、先可测再优化、先一致再扩展

---

## 1. 当前现状摘要

### 1.1 架构与能力概况

- 诊断调度与并发控制已具备基础实现（`src/diagnostics/scheduler.ts`）
- 增量诊断与增量格式化默认启用（`src/config/index.ts`）
- 性能基准脚本已具备但未纳入 CI（`tests/perf/run-performance-benchmark.js`）

### 1.2 需要立即收敛的技术债

- 缓存管理器双实现并存：`cache-manager.ts` 与 `new-cache-manager.ts`
- LRU 缓存实现多版本并存：`advanced-lru-cache.ts`、`optimized-lru-cache.ts`、`lru-cache.ts`
- include 缓存策略未统一为容量/TTL 可控实现（`src/diagnostics/include-resolver.ts`）

---

## 2. 关键风险与影响

- 性能监控口径分裂导致指标不可比较
- 缓存命中与驱逐统计不一致导致内存评估失真
- 重复实现并存导致行为差异扩大维护成本
- 增量脏区计算不稳影响格式化与诊断一致性
- 诊断调度重叠导致队列堆积与 UI 卡顿

---

## 3. 近期目标（P0 / 1-2 个月）

### 3.1 缓存治理与一致性

- [ ] 统一 CacheManager 单一实现与注册入口
- [ ] 统一 LRU 缓存实现与使用边界
- [ ] include 缓存迁移至 LRU 并增加容量上限与 TTL
- [ ] 增强缓存主动清理策略（内存压力触发）

### 3.2 增量解析与格式化稳定性

- [ ] 修复 AST 缓存重复注册问题（`src/utils/incremental-tracker.ts`）
- [ ] 优化脏区计算准确性（`src/utils/incremental-parser.ts`）
- [ ] 变更合并算法回归测试补齐（增量路径一致性）

### 3.3 质量门槛固化

- [ ] CI 加入覆盖率任务并做失败阻断
- [ ] CI 增加性能基准任务并记录基线
- [ ] 保留并扩展跨文件集成测试种子

---

## 4. 中期目标（P1 / 3-6 个月）

### 4.1 诊断调度与性能优化

- [ ] 调度去重与并发控制策略升级（`src/diagnostics/scheduler.ts`）
- [ ] 热点路径解析优先级与慢操作告警

### 4.2 跨文件可靠性

- [ ] include 链与循环依赖集成测试
- [ ] 引用/定义跨文件一致性与重命名回归
- [ ] 诊断增量/全量一致性验证

### 4.3 架构解耦准备

- [ ] 语言服务层抽象与接口定义
- [ ] 规划 LSP 迁移路径与兼容策略

---

## 5. 长期目标（P2 / 6-12 个月）

- [ ] LSP 兼容性实现与能力迁移
- [ ] 高级编辑功能（Call Hierarchy/Type Hierarchy/Refactor）
- [ ] 性能基准体系与大型仓库压力测试
- [ ] 模块化与依赖注入改造
- [ ] 语义诊断与 Quick Fix 扩展

---

## 6. 里程碑与验收指标

### 6.1 性能指标

- 1000 行文件格式化 <500ms
- 导航 <100ms
- 诊断全量分析 <200ms

### 6.2 可靠性指标

- 错误日志零崩溃
- 关键操作错误率 <1%

### 6.3 可维护性指标

- 关键模块重复逻辑显著减少并持续收敛
- 缓存与指标口径统一

---

## 7. 验证与发布门槛

- 变更提交前必须运行 `npm run lint` 与 `npm run test`
- 性能相关变更必须运行 `npm run perf:benchmark`
- 关键修复需包含最小回归测试

---

## 8. 变更记录

| 版本   | 主要更新 |
|--------|----------|
| 1.0.19 | 增量格式化缩进修复与回归测试；覆盖率脚本修复；全量测试通过 |
| 1.0.13 | Mocha 测试迁移与 formatter/diagnostics 相关修复 |
| 1.0.12 | AST/Parser 重构，增量分析/格式化与性能优化 |
